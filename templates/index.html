<!DOCTYPE html>
<html>
<head>
  <title>Anthoscope</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      cursor: url('/static/cursor.png'), auto !important;
    }
    
    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0;
    }
    #map { 
      height: 100%; 
      width: 100%;
    }
    
    #controls {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 0, 114, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 0, 114, 0.5);
      padding: 22px;
      border-radius: 10px;
      font-family: 'Montserrat', sans-serif;
      font-size: 21px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 375px;
    }
    
    #controls label {
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    #controls select {
      padding: 8px;
      width: 100%;
      font-size: 21px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    #controls button {
      margin-top: 15px;
      padding: 15px;
      width: 100%;
      background: rgba(200, 0, 90, 0.8);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 21px;
      font-weight: bold;
    }
    
    #controls button:hover {
      background: rgba(180, 0, 80, 0.9);
    }
    
    #controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    #forecast-info {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 0, 114, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 0, 114, 0.3);
      padding: 22px;
      border-radius: 10px;
      font-family: 'Montserrat', sans-serif;
      font-size: 19px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 450px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .forecast-day {
      margin: 10px 0;
      padding: 15px;
      border-left: 4px solid rgba(200, 0, 90, 0.8);
      background: rgba(248, 249, 250, 0.9);
    }
    
    .pollen-level {
      display: inline-block;
      padding: 3px 12px;
      border-radius: 3px;
      margin: 2px;
      font-size: 16px;
      font-weight: bold;
    }
    
    .level-0 { background: #e8e8e8; color: #666; }
    .level-1 { background: #c3f0c3; color: #2d5016; }
    .level-2 { background: #fff59d; color: #5d4e00; }
    .level-3 { background: #ffcc80; color: #663c00; }
    .level-4 { background: #ff8a65; color: #5d1700; }
    .level-5 { background: #ef5350; color: white; }
    
    #legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 0, 114, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 0, 114, 0.3);
      padding: 15px;
      border-radius: 10px;
      font-family: 'Montserrat', sans-serif;
      font-size: 21px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    
    .loading {
      color: #666;
      font-style: italic;
    }
    
    #review-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    #review-modal.active {
      display: flex;
    }
    
    .modal-content {
      background: rgba(255, 0, 114, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 0, 114, 0.3);
      padding: 25px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      font-family: 'Montserrat', sans-serif;
      font-size: 19px;
    }
    
    .modal-content h2 {
      margin-top: 0;
      color: white;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: white;
    }
    
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 19px;
      font-family: 'Montserrat', sans-serif;
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .checkbox-group label {
      font-weight: normal;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: auto;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-buttons button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 19px;
      font-weight: bold;
    }
    
    .btn-submit {
      background: rgba(200, 0, 90, 0.8);
      color: white;
    }
    
    .btn-submit:hover {
      background: rgba(180, 0, 80, 0.9);
    }
    
    .btn-cancel {
      background: #f1f1f1;
      color: #333;
    }
    
    .btn-cancel:hover {
      background: #e0e0e0;
    }
    
    .info-text {
      color: white;
      font-size: 17px;
      margin-top: 5px;
    }
  </style>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap&libraries=drawing">
  </script>
</head>
<body>
  <div id="controls">
    <strong>Pollen Heatmap</strong>
    
    <label>Pollen Type</label>
    <select id="pollenType">
      <option value="TREE_UPI">Tree Pollen</option>
      <option value="GRASS_UPI">Grass Pollen</option>
      <option value="WEED_UPI">Weed Pollen</option>
    </select>
    
    <button id="drawAreaBtn">Draw Area & Write Review</button>
    
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
      <small style="color: #666;">
        Heatmap shows current day data.<br>
        Click on map to see 5-day forecast.
      </small>
    </div>
  </div>
  
  <div id="forecast-info" style="display: none;">
    <strong id="forecast-title">5-Day Pollen Forecast</strong>
    <div id="forecast-content" class="loading">Click on the map...</div>
  </div>
  
  <div id="map"></div>
  
  <div id="legend">
    <strong>Pollen Index (UPI)</strong><br>
    <div><span style="color:#e0e0e0;">●</span> None (0)</div>
    <div><span style="color:#00ff00;">●</span> Very Low (1)</div>
    <div><span style="color:#a8ff00;">●</span> Low (2)</div>
    <div><span style="color:#ffff00;">●</span> Moderate (3)</div>
    <div><span style="color:#ff8000;">●</span> High (4)</div>
    <div><span style="color:#ff0000;">●</span> Very High (5)</div>
  </div>

  <!-- Review Modal -->
  <div id="review-modal">
    <div class="modal-content">
      <h2>Write Allergy Review</h2>
      
      <div class="form-group">
        <label>Area Selected:</label>
        <div id="area-info" class="info-text"></div>
      </div>
      
      <div class="form-group">
        <label for="review-pollen-type">Pollen Type You're Allergic To:</label>
        <select id="review-pollen-type">
          <option value="Tree">Tree Pollen</option>
          <option value="Grass">Grass Pollen</option>
          <option value="Weed">Weed Pollen</option>
          <option value="Multiple">Multiple Types</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="severity">Severity of Allergy:</label>
        <select id="severity">
          <option value="Mild">Mild</option>
          <option value="Moderate">Moderate</option>
          <option value="Severe">Severe</option>
          <option value="Very Severe">Very Severe</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Symptoms (select all that apply):</label>
        <div class="checkbox-group">
          <label><input type="checkbox" value="Sneezing"> Sneezing</label>
          <label><input type="checkbox" value="Runny Nose"> Runny Nose</label>
          <label><input type="checkbox" value="Itchy Eyes"> Itchy Eyes</label>
          <label><input type="checkbox" value="Watery Eyes"> Watery Eyes</label>
          <label><input type="checkbox" value="Congestion"> Congestion</label>
          <label><input type="checkbox" value="Coughing"> Coughing</label>
          <label><input type="checkbox" value="Breathing Difficulty"> Breathing Difficulty</label>
          <label><input type="checkbox" value="Skin Rash"> Skin Rash</label>
          <label><input type="checkbox" value="None"> None</label>
        </div>
      </div>
      
      <div class="form-group">
        <label for="review-text">Additional Comments (Optional):</label>
        <textarea id="review-text" placeholder="Share your experience with pollen allergies in this area..."></textarea>
      </div>
      
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeReviewModal()">Cancel</button>
        <button class="btn-submit" onclick="submitReview()">Submit Review</button>
      </div>
    </div>
  </div>

  <script>
    const GOOGLE_KEY = "{{ google_api_key }}";
    const FORECAST_API = "https://pollen.googleapis.com/v1/forecast:lookup";
    
    let map, pollenOverlay, forecastMarker, drawingManager;
    let currentCircle = null;
    let isDrawingMode = false;

    function initMap() {
      const center = { lat: 50.7374, lng: 7.0982 };
      
      map = new google.maps.Map(document.getElementById("map"), {
        center: center,
        zoom: 6,
        mapTypeId: 'roadmap',
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        styles: [
          {
            "elementType": "geometry",
            "stylers": [{"color": "#ffe0ee"}]
          },
          {
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#cc0066"}]
          },
          {
            "elementType": "labels.text.stroke",
            "stylers": [{"color": "#ffffff"}]
          },
          {
            "featureType": "administrative",
            "elementType": "geometry.stroke",
            "stylers": [{"color": "#ff0072"}]
          },
          {
            "featureType": "administrative.country",
            "elementType": "geometry.stroke",
            "stylers": [{"color": "#dd0066"}, {"weight": 2}]
          },
          {
            "featureType": "administrative.province",
            "elementType": "geometry.stroke",
            "stylers": [{"color": "#ff3388"}]
          },
          {
            "featureType": "landscape",
            "elementType": "geometry",
            "stylers": [{"color": "#fff0f7"}]
          },
          {
            "featureType": "poi",
            "elementType": "geometry",
            "stylers": [{"color": "#ffe6f0"}]
          },
          {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [{"color": "#ffccdd"}]
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry",
            "stylers": [{"color": "#ffb3cc"}]
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry.stroke",
            "stylers": [{"color": "#ff99bb"}]
          },
          {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [{"color": "#e0f0ff"}]
          }
        ]
      });

      updatePollenOverlay('TREE_UPI');

      document.getElementById('pollenType').addEventListener('change', function(e) {
        updatePollenOverlay(e.target.value);
      });
      
      map.addListener('click', function(e) {
        if (!isDrawingMode) {
          showForecast(e.latLng.lat(), e.latLng.lng());
        }
      });
      
      // Initialize DrawingManager
      drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: false,
        circleOptions: {
          fillColor: 'rgba(200, 0, 90, 0.5)',
          fillOpacity: 0.3,
          strokeWeight: 2,
          strokeColor: 'rgba(200, 0, 90, 0.8)',
          clickable: false,
          editable: true,
          zIndex: 1
        }
      });
      
      google.maps.event.addListener(drawingManager, 'circlecomplete', function(circle) {
        if (currentCircle) {
          currentCircle.setMap(null);
        }
        currentCircle = circle;
        drawingManager.setDrawingMode(null);
        isDrawingMode = false;
        document.getElementById('drawAreaBtn').textContent = 'Draw Area & Write Review';
        openReviewModal(circle);
      });
      
      document.getElementById('drawAreaBtn').addEventListener('click', toggleDrawingMode);
      
      showForecast(center.lat, center.lng);
      loadExistingReviews();
    }

    function updatePollenOverlay(pollenType) {
      map.overlayMapTypes.clear();

      pollenOverlay = new google.maps.ImageMapType({
        getTileUrl: function(coord, zoom) {
          const numTiles = Math.pow(2, zoom);
          if (coord.x < 0 || coord.x >= numTiles || coord.y < 0 || coord.y >= numTiles) {
            return null;
          }
          return `https://pollen.googleapis.com/v1/mapTypes/${pollenType}/heatmapTiles/${zoom}/${coord.x}/${coord.y}?key=${GOOGLE_KEY}`;
        },
        tileSize: new google.maps.Size(256, 256),
        opacity: 0.6,
        name: 'Pollen'
      });

      map.overlayMapTypes.push(pollenOverlay);
    }
    
    function toggleDrawingMode() {
      if (isDrawingMode) {
        drawingManager.setMap(null);
        isDrawingMode = false;
        document.getElementById('drawAreaBtn').textContent = 'Draw Area & Write Review';
      } else {
        drawingManager.setMap(map);
        drawingManager.setDrawingMode(google.maps.drawing.OverlayType.CIRCLE);
        isDrawingMode = true;
        document.getElementById('drawAreaBtn').textContent = 'Cancel Drawing';
      }
    }
    
    function openReviewModal(circle) {
      const center = circle.getCenter();
      const radius = circle.getRadius() / 1000; // Convert to km
      
      document.getElementById('area-info').textContent = 
        `Center: ${center.lat().toFixed(4)}, ${center.lng().toFixed(4)} | Radius: ${radius.toFixed(2)} km`;
      
      document.getElementById('review-modal').classList.add('active');
    }
    
    function closeReviewModal() {
      document.getElementById('review-modal').classList.remove('active');
      if (currentCircle) {
        currentCircle.setMap(null);
        currentCircle = null;
      }
      // Reset form
      document.getElementById('review-text').value = '';
      document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(cb => cb.checked = false);
    }
    
    async function submitReview() {
      if (!currentCircle) return;
      
      const center = currentCircle.getCenter();
      const radius = currentCircle.getRadius() / 1000;
      const pollenType = document.getElementById('review-pollen-type').value;
      const severity = document.getElementById('severity').value;
      const reviewText = document.getElementById('review-text').value;
      
      // Get selected symptoms
      const symptoms = [];
      document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked').forEach(cb => {
        symptoms.push(cb.value);
      });
      
      const reviewData = {
        centerLat: center.lat(),
        centerLng: center.lng(),
        radiusKm: radius,
        pollenType: pollenType,
        severity: severity,
        symptoms: symptoms,
        reviewText: reviewText
      };
      
      try {
        const response = await fetch('/api/reviews', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(reviewData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Review submitted successfully!');
          closeReviewModal();
          loadExistingReviews();
        } else {
          alert('Error submitting review: ' + result.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error submitting review. Please try again.');
      }
    }
    
    async function loadExistingReviews() {
      try {
        const response = await fetch('/api/reviews');
        const result = await response.json();
        
        if (result.success && result.reviews) {
          result.reviews.forEach(review => {
            const marker = new google.maps.Marker({
              position: { lat: review.center_lat, lng: review.center_lng },
              map: map,
              icon: {
                url: '/static/point.png',
                scaledSize: new google.maps.Size(40, 40)
              },
              clickable: true
            });
            
            marker.addListener('click', function() {
              showReviewDetails(review);
            });
          });
        }
      } catch (error) {
        console.error('Error loading reviews:', error);
      }
    }
    
    let reviewCircle = null;
    let reviewInfoWindow = null;
    
    function showReviewDetails(review) {
      // Remove previous circle and info window if exists
      if (reviewCircle) {
        reviewCircle.setMap(null);
      }
      if (reviewInfoWindow) {
        reviewInfoWindow.close();
      }
      
      // Create circle to show the reviewed area
      reviewCircle = new google.maps.Circle({
        center: { lat: review.center_lat, lng: review.center_lng },
        radius: review.radius_km * 1000,
        fillColor: 'rgba(200, 0, 90, 0.5)',
        fillOpacity: 0.2,
        strokeWeight: 2,
        strokeColor: 'rgba(200, 0, 90, 0.8)',
        map: map,
        clickable: false
      });
      
      // Create styled info window
      reviewInfoWindow = new google.maps.InfoWindow({
        content: `
          <div style="font-family: 'Montserrat', sans-serif; background: rgba(255, 0, 114, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255, 0, 114, 0.5); padding: 20px; border-radius: 10px; min-width: 300px; max-width: 450px;">
            <h3 style="margin-top: 0; color: rgba(200, 0, 90, 1); font-size: 21px;">Allergy Review</h3>
            <div style="margin-bottom: 10px; color: #666; font-size: 14px;">
              <strong>Location:</strong> ${review.center_lat.toFixed(4)}, ${review.center_lng.toFixed(4)}<br>
              <strong>Area Radius:</strong> ${review.radius_km.toFixed(2)} km
            </div>
            <p style="margin: 8px 0;"><strong style="color: #333;">Pollen Type:</strong> <span style="color: #555;">${review.pollen_type}</span></p>
            <p style="margin: 8px 0;"><strong style="color: #333;">Severity:</strong> <span style="color: #555;">${review.severity}</span></p>
            <p style="margin: 8px 0;"><strong style="color: #333;">Symptoms:</strong> <span style="color: #555;">${review.symptoms.length > 0 ? review.symptoms.join(', ') : 'None'}</span></p>
            ${review.review_text ? `<p style="margin: 12px 0 0 0; padding-top: 10px; border-top: 1px solid rgba(200, 0, 90, 0.3); font-style: italic; color: #444;">"${review.review_text}"</p>` : ''}
          </div>
        `,
        position: { lat: review.center_lat, lng: review.center_lng }
      });
      
      reviewInfoWindow.open(map);
      
      // Close circle and info window when clicking elsewhere
      const closeListener = google.maps.event.addListener(map, 'click', function() {
        if (reviewCircle) {
          reviewCircle.setMap(null);
          reviewCircle = null;
        }
        if (reviewInfoWindow) {
          reviewInfoWindow.close();
          reviewInfoWindow = null;
        }
        google.maps.event.removeListener(closeListener);
      });
    }
    
    // Health advice helper mapped to UPI and species-specific add-ons
    function getHealthAdvice(upi, speciesCode) {
      const base = {
        0: "No symptoms expected. You can safely spend time outside.",
        1: "Symptoms unlikely. Sensitive individuals may notice mild irritation; keep medication available.",
        2: "Minor symptoms possible (itchy eyes, light sneezing). Keep windows closed at night; shower after outdoor activity.",
        3: "Noticeable symptoms likely for allergic individuals. Limit outdoor exercise; use antihistamines; use HEPA filtration indoors.",
        4: "Strong symptoms for most allergic individuals. Avoid prolonged outdoor activity; wear a mask outdoors (FFP2/N95); keep windows closed; use air purifier.",
        5: "Severe symptoms expected. Stay indoors as much as possible; use AC+filtration; take prescribed medication; asthmatics keep inhaler accessible."
      }[upi] || "No advice available.";

      const extras = {
        BIRCH: " Rapid symptom onset in dry mornings.",
        HAZEL: " Early-spring reactions common.",
        ALDER: " May trigger strong eye symptoms.",
        OAK: " Keep car vents on recirculation when driving.",
        MAPLE: " Avoid forest-path jogging during peak.",
        RAGWEED: " Highly allergenic — avoid outdoor running 5–10 AM.",
        MUGWORT: " Cross-reactive with celery & spices; avoid those if sensitive.",
        GRAMINALES: " Avoid freshly mowed lawns.",
        OLIVE: " Nasal rinsing recommended to reduce buildup.",
        CYPRESS_PINE: " Sticky pollen; affects sinuses strongly.",
        JAPANESE_CEDAR: " Wear a mask outdoors during peak.",
        JUNIPER: " Can trigger asthma-like symptoms; keep inhaler handy."
      }[speciesCode] || "";

      return base + extras;
    }

    async function showForecast(lat, lng) {
      const forecastDiv = document.getElementById('forecast-info');
      const contentDiv = document.getElementById('forecast-content');
      
      forecastDiv.style.display = 'block';
      contentDiv.innerHTML = '<div class="loading">Loading forecast...</div>';
      
      if (forecastMarker) {
        forecastMarker.setPosition({lat, lng});
      } else {
        forecastMarker = new google.maps.Marker({
          position: {lat, lng},
          map: map,
          title: 'Forecast Location'
        });
      }
      
      try {
        const url = `${FORECAST_API}?key=${GOOGLE_KEY}&location.latitude=${lat}&location.longitude=${lng}&days=5`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.dailyInfo || data.dailyInfo.length === 0) {
          contentDiv.innerHTML = '<div>No forecast data available for this location.</div>';
          return;
        }
        
        let html = '<div style="margin-bottom: 10px; color: #666; font-size: 12px;">';
        html += `Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}</div>`;
        
        data.dailyInfo.forEach((day, index) => {
          const date = new Date(day.date.year, day.date.month - 1, day.date.day);
          const dateStr = date.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
          });
          
          html += `<div class="forecast-day">`;
          html += `<strong>${index === 0 ? 'Today' : dateStr}</strong><br>`;
          
          // Pollen type info (TREE/GRASS/WEED)
          if (day.pollenTypeInfo && day.pollenTypeInfo.length > 0) {
            day.pollenTypeInfo.forEach(pollen => {
              if (pollen.indexInfo) {
                const level = pollen.indexInfo.value || 0;
                const category = pollen.indexInfo.category || 'Unknown';
                html += `<span class="pollen-level level-${level}">`;
                html += `${pollen.displayName}: ${category}</span>`;
              } else {
                html += `<span class="pollen-level level-0">`;
                html += `${pollen.displayName}: None</span>`;
              }
            });
          } else {
            html += '<span style="color: #999;">No pollen type data</span>';
          }

          // Species / plantInfo breakdown (if available)
          if (day.plantInfo && day.plantInfo.length > 0) {
            html += `<div style="margin-top:8px"><strong>Species Breakdown:</strong></div>`;
            day.plantInfo.forEach(species => {
              const level = species.indexInfo?.value || 0;
              const category = species.indexInfo?.category || 'None';

              html += `<div style="margin-top:6px">`;
              html += `<span class="pollen-level level-${level}">`;
              html += `${species.displayName}: ${category}</span>`;

              // Append concise health advice preview (short)
              const advicePreview = getHealthAdvice(level, species.code);
              html += `<div style="font-size:14px; margin-left:10px; color:#555;">${advicePreview}</div>`;

              html += `</div>`;
            });
          }
          
          html += `</div>`;
        });
        
        contentDiv.innerHTML = html;
        
      } catch (error) {
        console.error('Error fetching forecast:', error);
        contentDiv.innerHTML = '<div style="color: red;">Error loading forecast data.</div>';
      }
    }
  </script>
</body>
</html>
