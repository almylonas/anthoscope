<!DOCTYPE html>
<html>
<head>
  <title>Pollen Heatmap with Forecast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }
    
    #controls {
      position: absolute;
      top: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      font-family: sans-serif;
      font-size: 14px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 250px;
    }
    
    #controls label {
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    #controls select {
      padding: 5px;
      width: 100%;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    #forecast-info {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      font-family: sans-serif;
      font-size: 13px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 300px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .forecast-day {
      margin: 10px 0;
      padding: 10px;
      border-left: 4px solid #4285f4;
      background: #f8f9fa;
    }
    
    .pollen-level {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      margin: 2px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .level-0 { background: #e8e8e8; color: #666; }
    .level-1 { background: #c3f0c3; color: #2d5016; }
    .level-2 { background: #fff59d; color: #5d4e00; }
    .level-3 { background: #ffcc80; color: #663c00; }
    .level-4 { background: #ff8a65; color: #5d1700; }
    .level-5 { background: #ef5350; color: white; }
    
    #legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      font-family: sans-serif;
      font-size: 14px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    
    .loading {
      color: #666;
      font-style: italic;
    }
  </style>

  <!-- Load Google Maps API -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap">
  </script>
</head>
<body>
  <div id="controls">
    <strong>Pollen Heatmap</strong>
    
    <label>Pollen Type</label>
    <select id="pollenType">
      <option value="TREE_UPI">Tree Pollen</option>
      <option value="GRASS_UPI">Grass Pollen</option>
      <option value="WEED_UPI">Weed Pollen</option>
    </select>
    
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
      <small style="color: #666;">
        Heatmap shows current day data.<br>
        Click on map to see 5-day forecast.
      </small>
    </div>
  </div>
  
  <div id="forecast-info" style="display: none;">
    <strong id="forecast-title">5-Day Pollen Forecast</strong>
    <div id="forecast-content" class="loading">Click on the map...</div>
  </div>
  
  <div id="map"></div>
  
  <div id="legend">
    <strong>Pollen Index (UPI)</strong><br>
    <div><span style="color:#e0e0e0;">●</span> None (0)</div>
    <div><span style="color:#00ff00;">●</span> Very Low (1)</div>
    <div><span style="color:#a8ff00;">●</span> Low (2)</div>
    <div><span style="color:#ffff00;">●</span> Moderate (3)</div>
    <div><span style="color:#ff8000;">●</span> High (4)</div>
    <div><span style="color:#ff0000;">●</span> Very High (5)</div>
  </div>

  <script>
    const GOOGLE_KEY = "{{ google_api_key }}";
    const FORECAST_API = "https://pollen.googleapis.com/v1/forecast:lookup";
    
    let map, pollenOverlay, forecastMarker;

    function initMap() {
      // Center on Bonn, Germany
      const center = { lat: 50.7374, lng: 7.0982 };
      
      map = new google.maps.Map(document.getElementById("map"), {
        center: center,
        zoom: 6,
        mapTypeId: 'roadmap'
      });

      // Create initial pollen overlay
      updatePollenOverlay('TREE_UPI');

      // Add event listener for pollen type selector
      document.getElementById('pollenType').addEventListener('change', function(e) {
        updatePollenOverlay(e.target.value);
      });
      
      // Add click listener to show forecast
      map.addListener('click', function(e) {
        showForecast(e.latLng.lat(), e.latLng.lng());
      });
      
      // Show initial forecast for center
      showForecast(center.lat, center.lng);
    }

    function updatePollenOverlay(pollenType) {
      // Clear all existing overlays
      map.overlayMapTypes.clear();

      // Create custom image map type for pollen heatmap tiles
      pollenOverlay = new google.maps.ImageMapType({
        getTileUrl: function(coord, zoom) {
          // Validate coordinates for the zoom level
          const numTiles = Math.pow(2, zoom);
          if (coord.x < 0 || coord.x >= numTiles || coord.y < 0 || coord.y >= numTiles) {
            return null;
          }
          
          // Construct the heatmap tile URL (current day only)
          return `https://pollen.googleapis.com/v1/mapTypes/${pollenType}/heatmapTiles/${zoom}/${coord.x}/${coord.y}?key=${GOOGLE_KEY}`;
        },
        tileSize: new google.maps.Size(256, 256),
        opacity: 0.6,
        name: 'Pollen'
      });

      // Add the overlay to the map
      map.overlayMapTypes.push(pollenOverlay);
    }
    
    async function showForecast(lat, lng) {
      const forecastDiv = document.getElementById('forecast-info');
      const contentDiv = document.getElementById('forecast-content');
      
      forecastDiv.style.display = 'block';
      contentDiv.innerHTML = '<div class="loading">Loading forecast...</div>';
      
      // Add or update marker
      if (forecastMarker) {
        forecastMarker.setPosition({lat, lng});
      } else {
        forecastMarker = new google.maps.Marker({
          position: {lat, lng},
          map: map,
          title: 'Forecast Location'
        });
      }
      
      try {
        const url = `${FORECAST_API}?key=${GOOGLE_KEY}&location.latitude=${lat}&location.longitude=${lng}&days=5`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.dailyInfo || data.dailyInfo.length === 0) {
          contentDiv.innerHTML = '<div>No forecast data available for this location.</div>';
          return;
        }
        
        let html = '<div style="margin-bottom: 10px; color: #666; font-size: 12px;">';
        html += `Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}</div>`;
        
        data.dailyInfo.forEach((day, index) => {
          const date = new Date(day.date.year, day.date.month - 1, day.date.day);
          const dateStr = date.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
          });
          
          html += `<div class="forecast-day">`;
          html += `<strong>${index === 0 ? 'Today' : dateStr}</strong><br>`;
          
          if (day.pollenTypeInfo && day.pollenTypeInfo.length > 0) {
            day.pollenTypeInfo.forEach(pollen => {
              if (pollen.indexInfo) {
                const level = pollen.indexInfo.value || 0;
                const category = pollen.indexInfo.category || 'Unknown';
                html += `<span class="pollen-level level-${level}">`;
                html += `${pollen.displayName}: ${category}</span>`;
              }
            });
          } else {
            html += '<span style="color: #999;">No data</span>';
          }
          
          html += `</div>`;
        });
        
        contentDiv.innerHTML = html;
        
      } catch (error) {
        console.error('Error fetching forecast:', error);
        contentDiv.innerHTML = '<div style="color: red;">Error loading forecast data.</div>';
      }
    }
  </script>
</body>
</html>